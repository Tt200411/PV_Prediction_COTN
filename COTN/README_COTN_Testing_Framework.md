# COTNå…‰ä¼é¢„æµ‹å®Œæ•´æµ‹è¯•æ¡†æ¶

æœ¬æ¡†æ¶å®ç°äº†COTN (Continuous Oscillator Time Networks) æ¨¡å‹åœ¨å…‰ä¼å‘ç”µé¢„æµ‹ä»»åŠ¡ä¸Šçš„å®Œæ•´æµ‹è¯•ä½“ç³»ï¼ŒåŒ…æ‹¬å•æ•°æ®é›†æµ‹è¯•ã€å¤šæ•°æ®é›†å¯¹æ¯”ã€æ»šåŠ¨å›æµ‹ç­‰åŠŸèƒ½ã€‚

## ğŸ“ æ–‡ä»¶ç»“æ„

```
COTN/
â”œâ”€â”€ prepare_pv_data.py          # å…‰ä¼æ•°æ®é¢„å¤„ç†è„šæœ¬
â”œâ”€â”€ train_pv_prediction.py     # åŸºç¡€COTNè®­ç»ƒè„šæœ¬
â”œâ”€â”€ backtest_framework.py      # æ»šåŠ¨å›æµ‹æ¡†æ¶
â”œâ”€â”€ multi_dataset_tester.py    # å¤šæ•°æ®é›†æµ‹è¯•æ¡†æ¶  
â”œâ”€â”€ cotn_complete_tester.py    # å®Œæ•´æµ‹è¯•å¥—ä»¶é›†æˆ
â”œâ”€â”€ debug_loader.py            # æ•°æ®åŠ è½½å™¨è°ƒè¯•å·¥å…·
â”œâ”€â”€ exp/
â”‚   â”œâ”€â”€ exp_config.py          # COTNæ¨¡å‹é…ç½® (å·²é€‚é…å…‰ä¼æ•°æ®)
â”‚   â””â”€â”€ exp_informer.py        # COTNå®éªŒç±» (å·²æ·»åŠ å…‰ä¼æ•°æ®æ˜ å°„)
â”œâ”€â”€ data/
â”‚   â””â”€â”€ data_loader.py         # æ•°æ®åŠ è½½å™¨ (å·²ä¿®æ”¹ä¸ºæ—¶é—´åºåˆ—åˆ†å‰²)
â””â”€â”€ ETT-small/
    â”œâ”€â”€ PV_Solar_Station_1.csv # å·²è½¬æ¢çš„å…‰ä¼æ•°æ®
    â””â”€â”€ ...                    # å…¶ä»–æ•°æ®é›†å°†åŠ¨æ€ç”Ÿæˆ
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡
```bash
# æ¿€æ´»torchç¯å¢ƒ
conda activate torch

# ç¡®ä¿åœ¨COTNç›®å½•ä¸‹
cd /Users/tangbao/Desktop/PV_prediction/COTN
```

### 2. åŸºç¡€è®­ç»ƒ
```bash
# è®­ç»ƒSite 1æ•°æ®é›†ä¸Šçš„COTNæ¨¡å‹
python train_pv_prediction.py
```

### 3. å®Œæ•´æµ‹è¯•å¥—ä»¶
```bash
# è¿è¡Œå®Œæ•´çš„æµ‹è¯•å¥—ä»¶
python cotn_complete_tester.py
```

## ğŸ“Š æµ‹è¯•æ¡†æ¶è¯¦è§£

### 1. å•æ•°æ®é›†æµ‹è¯• (`train_pv_prediction.py`)

**åŠŸèƒ½**: åœ¨å•ä¸ªå…‰ä¼ç”µç«™æ•°æ®ä¸Šè®­ç»ƒå’Œè¯„ä¼°COTNæ¨¡å‹

**é…ç½®**:
- è¾“å…¥åºåˆ—é•¿åº¦: 96ä¸ªæ—¶é—´æ­¥ (24å°æ—¶)
- é¢„æµ‹åºåˆ—é•¿åº¦: 24ä¸ªæ—¶é—´æ­¥ (6å°æ—¶)  
- æ—¶é—´åºåˆ—åˆ†å‰²: å‰80%è®­ç»ƒï¼Œå20%æµ‹è¯•
- å•å˜é‡é¢„æµ‹: åªé¢„æµ‹å‘ç”µåŠŸç‡

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from cotn_complete_tester import run_cotn_on_single_dataset

# æµ‹è¯•å•ä¸ªæ•°æ®é›†
result = run_cotn_on_single_dataset("Site_1_50MW")
print(f"RÂ²: {result['pred_result']['r2']:.3f}")
```

### 2. æ»šåŠ¨å›æµ‹æ¡†æ¶ (`backtest_framework.py`)

**åŠŸèƒ½**: æ¨¡æ‹ŸçœŸå®éƒ¨ç½²ç¯å¢ƒçš„æ»šåŠ¨é¢„æµ‹æµ‹è¯•

**ç‰¹ç‚¹**:
- **æ‰©å±•çª—å£**: ä½¿ç”¨æ‰€æœ‰å†å²æ•°æ®è®­ç»ƒ
- **å›ºå®šé¢„æµ‹çª—å£**: æ¯æ¬¡é¢„æµ‹6å°æ—¶
- **å®šæœŸé‡è®­ç»ƒ**: é¿å…æ¨¡å‹æ¼‚ç§»
- **æ­¥è¿›å¼è¯„ä¼°**: æ¯6å°æ—¶è¯„ä¼°ä¸€æ¬¡æ€§èƒ½

**å…³é”®å‚æ•°**:
```python
WalkForwardBacktest(
    model=cotn_model,
    data=pv_data,
    train_window=None,      # æ‰©å±•çª—å£
    test_window=24,         # é¢„æµ‹6å°æ—¶  
    step_size=24,           # æ¯æ¬¡å‰è¿›6å°æ—¶
    retrain_freq=96         # æ¯24å°æ—¶é‡è®­ç»ƒ
)
```

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from cotn_complete_tester import run_cotn_backtest

# è¿è¡Œæ»šåŠ¨å›æµ‹
backtest, summary, results = run_cotn_backtest()
print(f"å¹³å‡MAE: {summary['avg_mae']:.3f} MW")
```

### 3. å¤šæ•°æ®é›†æµ‹è¯•æ¡†æ¶ (`multi_dataset_tester.py`)

**åŠŸèƒ½**: åœ¨æ‰€æœ‰8ä¸ªå…‰ä¼ç”µç«™æ•°æ®ä¸Šè¯„ä¼°æ¨¡å‹æ³›åŒ–æ€§èƒ½

**ç”µç«™ä¿¡æ¯**:
| ç”µç«™ | è£…æœºå®¹é‡ | æ•°æ®ç‰¹ç‚¹ |
|------|----------|----------|
| Site 1 | 50MW | ä¸­ç­‰è§„æ¨¡ |
| Site 2 | 130MW | å¤§è§„æ¨¡ |
| Site 3 | 30MW | å°è§„æ¨¡ |
| Site 4 | 130MW | å¤§è§„æ¨¡ |
| Site 5 | 110MW | å¤§è§„æ¨¡ |
| Site 6 | 35MW | å°è§„æ¨¡ |
| Site 7 | 30MW | å°è§„æ¨¡ |
| Site 8 | 30MW | å°è§„æ¨¡ |

**è‡ªåŠ¨åŒ–æµç¨‹**:
1. è‡ªåŠ¨åŠ è½½æ‰€æœ‰æ•°æ®é›†
2. è½¬æ¢ä¸ºCOTNå…¼å®¹æ ¼å¼
3. ä¾æ¬¡è®­ç»ƒå’Œæµ‹è¯•
4. ç”Ÿæˆæ€§èƒ½å¯¹æ¯”æŠ¥å‘Š
5. å¯è§†åŒ–ç»“æœå¯¹æ¯”

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from cotn_complete_tester import run_cotn_multi_dataset_test

# è¿è¡Œå¤šæ•°æ®é›†æµ‹è¯•
tester = run_cotn_multi_dataset_test()
```

## ğŸ”§ é…ç½®è¯´æ˜

### COTNæ¨¡å‹é…ç½® (`exp/exp_config.py`)

å·²é’ˆå¯¹å…‰ä¼é¢„æµ‹ä»»åŠ¡ä¼˜åŒ–çš„å…³é”®é…ç½®:

```python
class InformerConfig:
    def __init__(self):
        # æ—¶é—´åºåˆ—å‚æ•°
        self.seq_len = 96      # è¾“å…¥: 24å°æ—¶å†å²
        self.label_len = 48    # è§£ç å™¨èµ·å§‹: 12å°æ—¶
        self.pred_len = 24     # é¢„æµ‹: 6å°æ—¶æœªæ¥
        
        # æ¨¡å‹å‚æ•°  
        self.enc_in = 1        # å•å˜é‡è¾“å…¥
        self.dec_in = 1        # å•å˜é‡è§£ç 
        self.c_out = 1         # å•å˜é‡è¾“å‡º
        
        # æ•°æ®å‚æ•°
        self.features = 'S'    # å•å˜é‡é¢„æµ‹æ¨¡å¼
        self.target = 'Power'  # ç›®æ ‡: å‘ç”µåŠŸç‡
        self.freq = 't'        # åˆ†é’Ÿçº§æ—¶é—´ç‰¹å¾
```

### æ—¶é—´åºåˆ—åˆ†å‰²ç­–ç•¥

**ä¸¥æ ¼æ—¶é—´åˆ†å‰²**:
- è®­ç»ƒé›†: å‰80%æ•°æ®ï¼ˆæ—¶é—´é¡ºåºï¼‰
- æµ‹è¯•é›†: å20%æ•°æ®ï¼ˆæœªæ¥æ•°æ®ï¼‰
- æ— æ•°æ®æ³„éœ²: æµ‹è¯•é›†å®Œå…¨ä¸å¯è§

**æ»‘åŠ¨çª—å£ç”Ÿæˆ**:
- æ ·æœ¬1: æ—¶é—´æ­¥[0:95] â†’ é¢„æµ‹[96:119]  
- æ ·æœ¬2: æ—¶é—´æ­¥[1:96] â†’ é¢„æµ‹[97:120]
- ...
- æ ·æœ¬N: æ—¶é—´æ­¥[N:N+95] â†’ é¢„æµ‹[N+96:N+119]

## ğŸ“ˆ æ€§èƒ½åŸºå‡†

### ä¸éšæœºæ£®æ—å¯¹æ¯”

**éšæœºæ£®æ—åŸºå‡†** (ç°æœ‰é¡¹ç›®ç»“æœ):
- æ˜ å°„å¼é¢„æµ‹: RÂ² = 0.967, MAE = 0.944 MW
- æ—¶é—´åºåˆ—é¢„æµ‹: RÂ² = 0.871, MAE = 1.988 MW

**COTNç›®æ ‡**:
- æ—¶é—´åºåˆ—å»ºæ¨¡: æœŸæœ›RÂ² > 0.871
- é•¿æœŸä¾èµ–: æ›´å¥½çš„å¤šæ­¥é¢„æµ‹èƒ½åŠ›
- æ¨¡å¼è¯†åˆ«: è‡ªåŠ¨å­¦ä¹ å¤æ‚å¤©æ°”-å‘ç”µå…³ç³»

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è®­ç»ƒæ•°æ®é•¿åº¦é”™è¯¯**
   ```
   é”™è¯¯: __len__() should return >= 0
   è§£å†³: æ£€æŸ¥seq_len + pred_lenæ˜¯å¦å°äºæ•°æ®é›†å¤§å°
   ```

2. **GPUå†…å­˜ä¸è¶³**
   ```
   è§£å†³: è®¾ç½®config.use_gpu = Falseä½¿ç”¨CPUè®­ç»ƒ
   ```

3. **æ—¶é—´ç‰¹å¾è§£æé”™è¯¯**
   ```
   é”™è¯¯: '15min' not supported
   è§£å†³: ä½¿ç”¨config.freq = 't'ä½œä¸ºåˆ†é’Ÿçº§é¢‘ç‡
   ```

4. **æ¨¡å‹ç»´åº¦ä¸åŒ¹é…**
   ```
   é”™è¯¯: expected input[32, 1, 98] to have 6 channels
   è§£å†³: ç¡®ä¿config.enc_inä¸featuresæ¨¡å¼åŒ¹é…
   ```

### æ€§èƒ½ä¼˜åŒ–

1. **è®­ç»ƒåŠ é€Ÿ**:
   - ä½¿ç”¨GPU: `config.use_gpu = True`
   - å‡å°‘epochs: `config.train_epochs = 3`
   - å°æ‰¹é‡: `config.batch_size = 16`

2. **å›æµ‹ä¼˜åŒ–**:
   - å¢å¤§step_sizeå‡å°‘å›æµ‹æ¬¡æ•°
   - ä½¿ç”¨å›ºå®šçª—å£è€Œéæ‰©å±•çª—å£
   - é™ä½é‡è®­ç»ƒé¢‘ç‡

## ğŸ“ è¾“å‡ºæ–‡ä»¶

### è‡ªåŠ¨ç”Ÿæˆçš„ç»“æœæ–‡ä»¶

1. **æ¨¡å‹æ–‡ä»¶**:
   - `checkpoints/informer_PV_*.pth`: è®­ç»ƒå¥½çš„æ¨¡å‹æƒé‡

2. **å¯è§†åŒ–ç»“æœ**:
   - `cotn_pv_prediction_results.png`: å•æ•°æ®é›†é¢„æµ‹ç»“æœ
   - `cotn_backtest_results.png`: æ»šåŠ¨å›æµ‹ç»“æœ
   - `multi_dataset_comparison.png`: å¤šæ•°æ®é›†æ€§èƒ½å¯¹æ¯”

3. **æŠ¥å‘Šæ–‡ä»¶**:
   - `multi_dataset_report.csv`: è¯¦ç»†æ€§èƒ½æ•°æ®
   - `comprehensive_report.txt`: ç»¼åˆæµ‹è¯•æŠ¥å‘Š

## ğŸ”„ æ‰©å±•ä½¿ç”¨

### æ·»åŠ æ–°æ•°æ®é›†

1. å°†Excelæ–‡ä»¶æ”¾å…¥`/Users/tangbao/Desktop/PV_prediction/Solar Station/`
2. è¿è¡Œå¤šæ•°æ®é›†æµ‹è¯•å™¨ä¼šè‡ªåŠ¨è¯†åˆ«å’Œå¤„ç†

### è‡ªå®šä¹‰é…ç½®

```python
# åˆ›å»ºè‡ªå®šä¹‰é…ç½®
custom_config = {
    'seq_len': 192,     # ä½¿ç”¨2å¤©å†å²
    'pred_len': 48,     # é¢„æµ‹12å°æ—¶
    'train_epochs': 10, # æ›´å¤šè®­ç»ƒè½®æ•°
}

# åº”ç”¨åˆ°æ¨¡å‹
model = COTNModelWrapper("Site_1_50MW", config_overrides=custom_config)
```

### é›†æˆå…¶ä»–æ¨¡å‹

æ¡†æ¶è®¾è®¡ä¸ºæ¨¡å—åŒ–ï¼Œå¯ä»¥è½»æ¾æ›¿æ¢COTNä¸ºå…¶ä»–æ—¶é—´åºåˆ—æ¨¡å‹ï¼Œåªéœ€å®ç°ç›¸åŒçš„æ¥å£:

```python
class YourModel:
    def fit(self, train_data): pass
    def predict(self, test_data): pass
```

---

**æ³¨**: æœ¬æ¡†æ¶ä¸ºCOTNåœ¨å…‰ä¼é¢„æµ‹ä»»åŠ¡ä¸Šçš„å®Œæ•´å®ç°ï¼Œæä¾›äº†ä»æ•°æ®é¢„å¤„ç†åˆ°æ€§èƒ½è¯„ä¼°çš„å…¨æµç¨‹å·¥å…·é“¾ã€‚